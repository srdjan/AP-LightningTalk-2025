<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI Agent Talk ‚Äî Modular</title>
  <link rel="stylesheet" href="theme.css">
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    body{min-height:100dvh;background:var(--bg);color:var(--text);font-family:var(--font-ui);overflow:hidden}
    main{container-type:inline-size;width:100vw;height:100vh;position:relative}
    section{position:absolute;inset:0;display:grid;place-items:center;padding:clamp(2rem,5vw,4rem);opacity:0;transform:translateX(100%);transition:all var(--dur) var(--easing)}
    section.active{opacity:1;transform:translateX(0)} section.prev{transform:translateX(-100%)}
    h1{font-size:clamp(2.2rem,7vw,3.6rem);font-weight:900;margin-bottom:1rem;color:var(--text)}
    h2{font-size:clamp(1.8rem,5.5vw,2.8rem);font-weight:800;margin-bottom:1rem;color:var(--primary)}
    h3{font-size:clamp(1.3rem,4vw,1.8rem);font-weight:700;margin:.5rem 0;color:var(--secondary)}
    p{font-size:clamp(1.05rem,2.5vw,1.3rem);line-height:1.7;max-width:900px;text-align:center;margin:.5rem 0}
    ul,ol{max-width:900px;margin:1rem auto;text-align:left;line-height:1.7}
    li{margin:.35rem 0}
    pre{max-width:900px;background:color-mix(in srgb,black 50%,var(--bg));padding:1rem;border-radius:1rem;border-left:4px solid var(--success);overflow:auto}
    code{font-family:var(--font-mono);font-size:clamp(.9rem,2vw,1.05rem)}
    .copy-btn{position:absolute;top:.5rem;right:.5rem;padding:.35rem .6rem;border:1px solid color-mix(in srgb,var(--primary) 40%,transparent);border-radius:.4rem;background:var(--glass);color:var(--text);cursor:pointer}
    .code-wrap{position:relative;display:inline-block}
    nav{position:fixed;left:50%;bottom:1.25rem;transform:translateX(-50%);display:flex;gap:.5rem;background:var(--glass);backdrop-filter:blur(10px);padding:.5rem 1rem;border-radius:2rem;border:1px solid color-mix(in srgb,var(--text) 10%,transparent);z-index:50}
    .dot{width:12px;height:12px;border-radius:50%;background:color-mix(in srgb,var(--primary) 30%,transparent);border:2px solid transparent;cursor:pointer;transition:all .25s}
    .dot.active{background:var(--primary);transform:scale(1.4);box-shadow:0 0 20px var(--primary)}
    dialog{max-width:700px;width:min(92vw,700px);background:var(--glass);backdrop-filter:blur(20px) saturate(160%);border:1px solid color-mix(in srgb,var(--text) 20%,transparent);border-radius:var(--radius);padding:1.25rem;color:var(--text)}
    dialog::backdrop{background:color-mix(in srgb,var(--bg) 80%,transparent);backdrop-filter:blur(6px)}
    .help-grid{display:grid;grid-template-columns:auto 1fr;gap:.6rem 1rem;margin:1rem 0}
    .btn{padding:.6rem 1rem;border-radius:.6rem;border:1px solid color-mix(in srgb,var(--primary) 40%,transparent);background:var(--glass);color:var(--text);cursor:pointer}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <main id="deck"></main>
  <nav id="nav" aria-label="Slide navigation"></nav>
  <dialog id="help">
    <h3>‚å®Ô∏è Keyboard Shortcuts</h3>
    <div class="help-grid">
      <kbd>‚Üí</kbd><span>Next slide</span>
      <kbd>‚Üê</kbd><span>Previous slide</span>
      <kbd>Space</kbd><span>Next slide</span>
      <kbd>Home</kbd><span>First slide</span>
      <kbd>End</kbd><span>Last slide</span>
      <kbd>H</kbd><span>Toggle help</span>
      <kbd>S</kbd><span>Toggle speaker notes</span>
      <kbd>Esc</kbd><span>Close dialog</span>
    </div>
    <button class="btn" onclick="help.close()">Got it!</button>
  </dialog>
  <dialog id="notes"><h3>üìù Speaker notes</h3><div id="notes-body" style="margin:.5rem 0 1rem"></div><button class="btn" onclick="notes.close()">Close</button></dialog>
  <div id="announcer" class="sr-only" aria-live="polite"></div>
  <script>
  const state={slides:[],htmlSections:[],notes:[],current:0,frags:[],fragIdx:[]};
  const deck=document.getElementById('deck');
  const nav=document.getElementById('nav');
  const help=document.getElementById('help');
  const notes=document.getElementById('notes');
  const notesBody=document.getElementById('notes-body');
  const announcer=document.getElementById('announcer');

  async function loadManifest(){
    const res=await fetch('slides/manifest.json');
    if(!res.ok) throw new Error('manifest load failed');
    return res.json();
  }

  function parseMarkdown(md){
    // Extract NOTES
    let note='';
    md=md.replace(/<!--\s*NOTES:\s*([\s\S]*?)-->/i,(m,body)=>{note=body.trim();return ''});
    const lines=md.split(/\r?\n/);
    let out="", inCode=false, listType=null; // 'ul' | 'ol'
    const flushList=()=>{ if(listType){ out+=`</${listType}>`; listType=null; } };
    for(let i=0;i<lines.length;i++){
      let line=lines[i];
      if(/^\s*$/.test(line)){ flushList(); continue; }
      if(line.trim().startsWith('<')){ flushList(); out+=line+"\n"; continue; }
      if(line.startsWith('```')){ if(!inCode){ flushList(); out+=`<div class=\"code-wrap\"><pre><code>`; inCode=true; } else { out+=`</code></pre><button class=\"copy-btn\" data-copy>Copy</button></div>`; inCode=false; } continue; }
      if(inCode){ out+=line.replace(/</g,'&lt;').replace(/>/g,'&gt;')+"\n"; continue; }
      const h3=line.match(/^###\s+(.*)/); if(h3){ flushList(); out+=`<h3>${h3[1]}</h3>`; continue; }
      const h2=line.match(/^##\s+(.*)/); if(h2){ flushList(); out+=`<h2>${h2[1]}</h2>`; continue; }
      const h1=line.match(/^#\s+(.*)/); if(h1){ flushList(); out+=`<h1>${h1[1]}</h1>`; continue; }
      const ol=line.match(/^\s*\d+\.\s+(.*)/); if(ol){ if(listType!=='ol'){ flushList(); out+='<ol>'; listType='ol'; } let item=ol[1]; const frag=/\s*\{\.fragment\}\s*$/.test(item); item=item.replace(/\s*\{\.fragment\}\s*$/,''); out+=`<li${frag?' class=\"fragment\"':''}>${item}</li>`; continue; }
      const ul=line.match(/^\s*[-\*]\s+(.*)/); if(ul){ if(listType!=='ul'){ flushList(); out+='<ul>'; listType='ul'; } let item=ul[1]; const frag=/\s*\{\.fragment\}\s*$/.test(item); item=item.replace(/\s*\{\.fragment\}\s*$/,''); out+=`<li${frag?' class=\"fragment\"':''}>${item}</li>`; continue; }
      flushList();
      // simple links [text](url)
      line=line.replace(/\[([^\]]+)\]\(([^\)]+)\)/g,'<a href=\"$2\" target=\"_blank\" rel=\"noopener\">$1</a>');
      out+=`<p>${line}</p>`;
    }
    flushList();
    return {html:out, note};
  }

  async function loadSlides(){
    const files=await loadManifest();
    for(const f of files){
      const res=await fetch(`slides/${f}`); const md=await res.text();
      const {html,note}=parseMarkdown(md);
      const sec=document.createElement('section'); sec.innerHTML=html; deck.appendChild(sec);
      state.htmlSections.push(sec); state.notes.push(note||'');
    }
    if(state.htmlSections.length){ state.htmlSections[0].classList.add('active'); }
    buildDots();
    collectFragments();
    enhanceCodeBlocks();
    const m=location.hash.match(/#(\d+)/); if(m){ goTo(parseInt(m[1],10)-1); } else { announce(); }
  }

  function buildDots(){
    nav.innerHTML=''; state.htmlSections.forEach((_,i)=>{ const b=document.createElement('button'); b.className='dot'+(i===0?' active':''); b.ariaLabel=`Go to slide ${i+1}`; b.onclick=()=>goTo(i); nav.appendChild(b); });
  }
  function collectFragments(){
    state.frags=state.htmlSections.map(sec=>Array.from(sec.querySelectorAll('.fragment')));
    state.fragIdx=state.frags.map(()=>0);
  }
  function enhanceCodeBlocks(){
    // already added copy buttons while parsing; wire handler
    document.addEventListener('click',e=>{ const btn=e.target.closest('[data-copy]'); if(!btn) return; const pre=btn.previousElementSibling; const code=pre?.querySelector('code'); if(code){ navigator.clipboard.writeText(code.textContent.trim()).then(()=>{ const t=btn.textContent; btn.textContent='Copied!'; setTimeout(()=>btn.textContent=t,1200); }); } });
  }

  function updateSlides(){
    state.htmlSections.forEach((sec,i)=>{ sec.classList.remove('active','prev'); if(i===state.current) sec.classList.add('active'); else if(i<state.current) sec.classList.add('prev'); });
    nav.querySelectorAll('.dot').forEach((d,i)=>d.classList.toggle('active',i===state.current));
    // render fragments visibility
    state.htmlSections.forEach((sec,i)=>{ const fr=state.frags[i]||[]; fr.forEach((el,j)=>{ el.style.opacity= j<state.fragIdx[i] ? '1':'0.15'; }); });
    announce();
  }
  function announce(){
    const sec=state.htmlSections[state.current]; const h=sec?.querySelector('h1,h2'); const title=h?.textContent||`Slide ${state.current+1}`; announcer.textContent=`${title}, slide ${state.current+1} of ${state.htmlSections.length}`; document.title=title+" ‚Äî AI Agent Talk";
  }

  function next(){ const fr=state.frags[state.current]||[]; if(state.fragIdx[state.current] < fr.length){ state.fragIdx[state.current]++; return updateSlides(); } if(state.current<state.htmlSections.length-1){ state.current++; state.fragIdx[state.current]=0; updateSlides(); location.hash="#"+(state.current+1); } }
  function prev(){ const fr=state.frags[state.current]||[]; if(state.fragIdx[state.current] > 0){ state.fragIdx[state.current]--; return updateSlides(); } if(state.current>0){ state.current--; state.fragIdx[state.current]=0; updateSlides(); location.hash="#"+(state.current+1); } }
  function goTo(n){ n=Math.max(0,Math.min(n,state.htmlSections.length-1)); state.current=n; state.fragIdx[n]=0; updateSlides(); location.hash="#"+(n+1); }

  // keyboard
  document.addEventListener('keydown',e=>{ if(e.target.tagName==='INPUT' || e.target.tagName==='TEXTAREA') return; const k=e.key; if(k==='ArrowRight'||k===' '){ e.preventDefault(); next(); } else if(k==='ArrowLeft'){ e.preventDefault(); prev(); } else if(k==='Home'){ e.preventDefault(); goTo(0); } else if(k==='End'){ e.preventDefault(); goTo(state.htmlSections.length-1); } else if(k.toLowerCase()==='h'){ e.preventDefault(); help.open?help.close():help.showModal(); } else if(k.toLowerCase()==='s'){ e.preventDefault(); showNotes(); } else if(k==='Escape'){ if(help.open) help.close(); if(notes.open) notes.close(); } });
  // mouse thirds
  document.addEventListener('click',e=>{ const t=e.target; if(!(t instanceof Element)) return; if(t.closest('nav,dialog,button,a')) return; const x=e.clientX,w=innerWidth; if(x>w*0.7) next(); else if(x<w*0.3) prev(); });
  // touch
  let startX=0; document.addEventListener('touchstart',e=>startX=e.touches[0].clientX); document.addEventListener('touchend',e=>{ const dx=startX-e.changedTouches[0].clientX; if(Math.abs(dx)>50) (dx>0?next:prev)(); });
  // hash
  addEventListener('hashchange',()=>{ const m=location.hash.match(/#(\d+)/); if(m){ goTo(parseInt(m[1],10)-1); }});

  function showNotes(){ const txt=state.notes[state.current] || (state.htmlSections[state.current]?.querySelector('h1,h2')?.textContent||''); notesBody.textContent=txt; notes.open?notes.close():notes.showModal(); }

  loadSlides();
  </script>
</body>
</html>

